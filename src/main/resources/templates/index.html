<!doctype html>
<!--suppress ALL -->
<html lang="ru" xmlns="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="css/alert.css" rel="stylesheet">
    <title>Админка</title>
</head>
<body>
<div class="p-3 bg-dark bg-gradient text-white row justify-content-between"> <!-- Верхняя серая строчка -->
    <div class="col-md-7"><h5><span sec:authentication="name">тут должно быть мыло и роли</span>
        , имеет роли:
        <span th:each="roleInList, iterStat : ${authenticatedUser.roles}"
              th:text="!${iterStat.last} ? ${#strings.substring(roleInList.roleTitle,5)} + ' '
                                                  : ${#strings.substring(roleInList.roleTitle,5)}">
                                            </span></h5>
    </div>
    <div class="col-md-1"><h5><a class="text-secondary" href="/logout">logout</a></h5></div>
</div> <!-- /Верхняя серая строчка -->

<div class="row"> <!-- Тело страницы после заголовка -->


    <div class="col-md-2 ">  <!-- Левое меню Админ - пользователь -->
        <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <button sec:authorize="hasRole('ROLE_ADMIN')" class="nav-link active" id="v-pills-admin-tab"
                    data-bs-toggle="pill" data-bs-target="#v-pills-admin"
                    type="button" role="tab" aria-controls="v-pills-admin" aria-selected="true">Админ
            </button>
            <button class="nav-link" id="v-pills-user-tab" data-bs-toggle="pill" data-bs-target="#v-pills-user"
                    type="button" role="tab" aria-controls="v-pills-user">Пользователь
            </button>
        </div>
    </div> <!-- /Левое меню Админ - пользователь -->


    <div class="tab-content col-md-10"> <!-- Контейнер вкладок центральной области-->
        <!-- Панель администратора-->
        <div sec:authorize="hasRole('ROLE_ADMIN')" class="tab-pane fade show active bg-light" id="v-pills-admin"
             role="tabpanel"
             aria-labelledby="v-pills-admin-tab">
            <h1><b>Панель администратора</b></h1>
            <div class="container-fluid">


                <nav> <!-- Меню Все пользователи - Новый -->
                    <div class="nav nav-tabs " id="nav-tab" role="tablist">
                        <button class="nav-link active btn-lg" id="nav-user_list-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-user_list" type="button" role="tab" aria-controls="nav-user_list"
                                aria-selected="true">Таблица Пользователей
                        </button>
                        <button class="nav-link btn-lg" id="nav-new_user-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-new_user" type="button" role="tab" aria-controls="nav-new_user"
                                aria-selected="false">Добавить нового
                        </button>
                    </div>
                </nav> <!-- /Меню Все пользователи - Новый -->

                <!--Контейнер  Все пользователи - новый -->
                <div class="tab-content" id="nav-tabContent">

                    <!-- Вкладка Все пользователи -->
                    <div class="tab-pane fade show active" id="nav-user_list" role="tabpanel"
                         aria-labelledby="nav-user_list-tab">
                        <div class="list-group">
                            <div class="list-group-item"><h4>Все пользователи</h4></div>
                            <div class="list-group-item">
                                <table class="table table-striped">
                                    <thead class="border-top fw-bold">
                                    <tr>
                                        <td>Ид</td>
                                        <td>Имя</td>
                                        <td>Фамилия</td>
                                        <td>Возраст</td>
                                        <td>Эл.почта</td>
                                        <td>Права</td>
                                        <td>Редакт.</td>
                                        <td>Удалить</td>
                                    </tr>
                                    </thead>
                                    <tbody th:each="cur_user : ${AllUsersList}">
                                    <tr>
                                        <td th:text="${cur_user.id}" th:id="'allListId_' + ${cur_user.id}">10500</td>
                                        <td th:text="${cur_user.name}">Имя</td>
                                        <td th:text="${cur_user.surname}">Фамилия</td>
                                        <td th:text="${cur_user.age}">13</td>
                                        <td th:text="${cur_user.email}">ee@Email</td>
                                        <td>
                                            <span th:each="roleInList, iterStat : ${cur_user.roles}"
                                                  th:text="!${iterStat.last} ? ${#strings.substring(roleInList.roleTitle,5)} + ' '
                                                  : ${#strings.substring(roleInList.roleTitle,5)}">
                                            </span>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-info text-white" data-bs-toggle="modal"
                                                    data-bs-target="#EditorModal"
                                                    th:onclick="'editButton(\'allListId_' + ${cur_user.id} + '\')'">
                                                Ред.
                                            </button>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                                    data-bs-target="#DeleteModal"
                                                    th:onclick="'deleteButton(\'allListId_' + ${cur_user.id} + '\')'">
                                                Удалить
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div> <!-- /Вкладка Все пользователи -->

                    <!-- Вкладка Новый пользователь -->
                    <div class="tab-pane fade" id="nav-new_user" role="tabpanel" aria-labelledby="nav-new_user-tab">
                        <div class="container-fluid p-3">
                            <h3>Добавить нового пользователя</h3>
                        </div>
                        <div class="container bg-white">
                            <!-- Форма нового пользователя-->
                            <form class="bg-white col-md-4 offset-md-4 text-md-center"
                                  th:action="@{/}" th:method="POST" th:object="${userDto}">
                                <div class="mb-3">
                                    <label for="InputName" class="form-label fw-bold ">Имя</label>
                                    <input th:field="*{name}" type="text" class="form-control" id="InputName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="InputSurname" class="form-label fw-bold">Фамилия</label>
                                    <input th:field="*{surname}" type="text" class="form-control" id="InputSurname"
                                           required>
                                </div>
                                <div class="mb-3">
                                    <label for="InputAge" class="form-label fw-bold">Возраст</label>
                                    <input th:field="*{age}" type="number" class="form-control" id="InputAge">
                                </div>
                                <div class="mb-3">
                                    <label for="InputEmail" class="form-label fw-bold">Электронная почта</label>
                                    <input th:field="*{email}" type="email" class="form-control" id="InputEmail"
                                           required>
                                </div>
                                <div class="mb-3">
                                    <label for="InputPassword" class="form-label fw-bold">Пароль</label>
                                    <input th:field="*{password}" type="password" class="form-control"
                                           id="InputPassword" required>
                                </div>
                                <div class="mb-4">
                                    <label for="Roles" class="form-label fw-bold">Роль</label>
                                    <select class="form-select" th:field="*{roles}" multiple id="Roles"
                                            aria-label="select-roles" required>
                                        <option th:each="roleType : ${allRolesList}"
                                                th:value="${{roleType}}"
                                                th:text="${roleType.roleTitle}">Роль
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary btn-lg p-3">Добавить пользователя
                                    </button>
                                </div>
                            </form> <!-- /Форма нового пользователя-->

                        </div>
                    </div> <!-- /Вкладка Новый пользователь -->


                </div> <!--/Контейнер  Все пользователи - новый -->

            </div>
        </div> <!-- /Панель администратора 2 div-->

        <!-- Тут страница текущего пользователя -->
        <div class="tab-pane fade bg-light" id="v-pills-user" role="tabpanel" aria-labelledby="v-pills-user-tab">
            <h1><b>Страница информации о пользователе</b></h1>
            <div class="container-fluid">

                <!-- Таблица о пользователе -->
                <div class="list-group-item bg-light"><h4>О пользователе</h4></div>
                <div class="list-group">
                    <div class="list-group-item">
                        <table class="table table-striped">
                            <thead class="border-top" style="font-weight: bold">
                            <tr>
                                <td>ID</td>
                                <td>First Name</td>
                                <td>Surname</td>
                                <td>Age</td>
                                <td>Email</td>
                                <td>role</td>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td th:text="${authenticatedUser.id}"
                                    th:id="'CurrentUserListId_' + ${authenticatedUser.id}">10500
                                </td>
                                <td th:text="${authenticatedUser.name}">Имя</td>
                                <td th:text="${authenticatedUser.surname}">Фамилия</td>
                                <td th:text="${authenticatedUser.age}">13</td>
                                <td th:text="${authenticatedUser.email}">ee@Email</td>
                                <td>
                                    <span th:each="roleInList, iterStat : ${authenticatedUser.roles}"
                                          th:text="!${iterStat.last} ? ${#strings.substring(roleInList.roleTitle,5)} + ' '
                                          : ${#strings.substring(roleInList.roleTitle,5)}">
                                    </span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>  <!-- /Таблица о пользователе -->

            </div>
        </div>   <!-- /Тут страница текущего пользователя  2 div -->
    </div> <!-- /Контейнер вкладок центральной области-->

</div> <!-- /Тело страницы после заголовка -->


<!-- Модальный редактор -->
<div class="modal fade" id="EditorModal" tabindex="-1" aria-labelledby="EditorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="EditorModalLabel">Редактировать пользователя</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <!-- Форма редактора пользователя-->
                <form class="bg-white col-md-6 offset-md-3 text-md-center" id="EditorModalForm"
                      th:method="PATCH" th:action="@{/}" th:object="${userDto}">
                    <div class="mb-3">
                        <label for="IdModalEditor" class="form-label fw-bold ">Идентификатор</label>
                        <input type="text" class="form-control" id="IdModalEditor" disabled>
                        <input type="hidden" id="RealIdModalEditor" name="id" th:field="*{id}" value=""/>
                    </div>

                    <div class="mb-3">
                        <label for="InputNameModalEditor" class="form-label fw-bold ">Имя</label>
                        <input type="text" class="form-control" id="InputNameModalEditor" th:field="*{name}" required>
                    </div>
                    <div class="mb-3">
                        <label for="InputSurnameModalEditor" class="form-label fw-bold">Фамилия</label>
                        <input type="text" class="form-control" id="InputSurnameModalEditor" th:field="*{surname}"
                               required>
                    </div>
                    <div class="mb-3">
                        <label for="InputAgeModalEditor" class="form-label fw-bold">Возраст</label>
                        <input type="number" class="form-control" id="InputAgeModalEditor" th:field="*{age}">
                    </div>
                    <div class="mb-3">
                        <label for="InputEmailModalEditor" class="form-label fw-bold">Электронная почта</label>
                        <input type="email" class="form-control" id="InputEmailModalEditor" th:field="*{email}"
                               required>
                    </div>
                    <div class="mb-3">
                        <label for="InputPasswordModalEditor" class="form-label fw-bold">Пароль</label>
                        <input type="password" class="form-control" id="InputPasswordModalEditor"
                               th:field="*{password}">
                    </div>
                    <div class="mb-4">
                        <label for="RolesModalEditor" class="form-label fw-bold">Роль</label>
                        <select class="form-select" th:field="*{roles}" multiple id="RolesModalEditor"
                                aria-label="select-roles" required>
                            <option th:each="roleType, iterStat : ${allRolesList}" th:value="${{roleType}}"
                                    th:text="${#strings.substring(roleType.roleTitle,5)}">Роль
                            </option>
                        </select>
                    </div>
                </form> <!-- /Форма редактора пользователя-->


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="submit" class="btn btn-primary" form="EditorModalForm">Сохранить</button>
            </div>
        </div>
    </div>
</div> <!-- /Модальный редактор -->

<!-- Модальный Удалитель -->
<div class="modal fade" id="DeleteModal" tabindex="-1" aria-labelledby="DeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="DeleteModalLabel">Удаление пользователя</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <!-- Форма удаления пользователя -->
                <form id="DeleteModalForm" class="bg-white col-md-6 offset-md-3 text-md-center" action="#"
                      th:method="DELETE">
                    <div class="mb-3">
                        <label for="IdModalDelete" class="form-label fw-bold ">Идентификатор</label>
                        <input type="text" class="form-control" id="IdModalDelete" disabled required>
                    </div>
                    <div class="mb-3">
                        <label for="InputNameModalDelete" class="form-label fw-bold ">Имя</label>
                        <input type="text" class="form-control" id="InputNameModalDelete" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="InputSurnameModalDelete" class="form-label fw-bold">Фамилия</label>
                        <input type="text" class="form-control" id="InputSurnameModalDelete" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="InputAgeModalDelete" class="form-label fw-bold">Возраст</label>
                        <input type="number" class="form-control" id="InputAgeModalDelete" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="InputEmailModalDelete" class="form-label fw-bold">Электронная почта</label>
                        <input type="email" class="form-control" id="InputEmailModalDelete" disabled>
                    </div>
                    <div class="mb-4">
                        <label for="RolesModalDelete" class="form-label fw-bold">Роль</label>
                        <select class="form-select" multiple id="RolesModalDelete" aria-label="select-roles" disabled>
                            <option th:each="roleType, iterStat : ${allRolesList}" th:value="${{roleType}}"
                                    th:text="${#strings.substring(roleType.roleTitle,5)}">Роль
                            </option>
                        </select>
                    </div>
                </form> <!-- /Форма удаления пользователя -->


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="submit" class="btn btn-danger" form="DeleteModalForm">Удалить</button>
            </div>
        </div>
    </div>
</div> <!-- /Модальный Удалитель -->

<div id="msg_pop">
    <span class="msg_close" onclick="document.getElementById('msg_pop').style.display='none'; return false;">X</span>
    <h3 class="text-danger" id="ResultMessage" th:text="${result}"></h3>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

<script type="text/javascript">

    function editButton(fieldId) {
        fieldId = document.querySelector('#' + fieldId)
        document.querySelector('#IdModalEditor').value = fieldId.firstChild.textContent // видимый Ид
        document.querySelector('#RealIdModalEditor').value = fieldId.firstChild.textContent // отправляемый Ид
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputNameModalEditor').value = fieldId.firstChild.textContent // name
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputSurnameModalEditor').value = fieldId.firstChild.textContent //surname
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputAgeModalEditor').value = fieldId.firstChild.textContent // age
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputEmailModalEditor').value = fieldId.firstChild.textContent //email
        fieldId = fieldId.nextElementSibling
        let roles = fieldId.textContent
        let options = document.querySelector('#RolesModalEditor').options
        for (let i = 0; i < options.length; i++) {
            options[i].selected = roles.includes(options[i].textContent);
        }
    }

    function deleteButton(fieldId) {
        fieldId = document.querySelector('#' + fieldId)
        document.querySelector('#IdModalDelete').value = fieldId.firstChild.textContent // id
        document.querySelector('#DeleteModalForm').action = '/' + fieldId.firstChild.textContent
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputNameModalDelete').value = fieldId.firstChild.textContent // name
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputSurnameModalDelete').value = fieldId.firstChild.textContent //surname
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputAgeModalDelete').value = fieldId.firstChild.textContent // age
        fieldId = fieldId.nextElementSibling
        document.querySelector('#InputEmailModalDelete').value = fieldId.firstChild.textContent //email
        fieldId = fieldId.nextElementSibling
        let roles = fieldId.textContent
        let options = document.querySelector('#RolesModalDelete').options
        for (let i = 0; i < options.length; i++) {
            options[i].selected = roles.includes(options[i].textContent);
        }
    }

    // Нужно для автовыбора левого меню в случае пользователя
    document.querySelector('#v-pills-tab').firstElementChild.click()
    // Возможные сообщения об операциях
    if (document.querySelector('#ResultMessage').textContent !== "") {
        let delay_popup = 2000;
        setTimeout("document.getElementById('msg_pop').style.display='block';document.getElementById('msg_pop').className += 'fadeIn';", delay_popup);
    }

</script>
</body>
</html>